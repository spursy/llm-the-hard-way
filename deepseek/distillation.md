# Distillation

## 什么是知识蒸馏

`
知识蒸馏是一种机器学习中模型压缩的技术，旨在将复杂的大型模型（称为教师模型）的知识迁移到较小模型（学生模型）。
`

## 核心原理

### 教师模型的作用

- 预先训练的教师模型是一个复杂而强大的网络，经过大规模数据训练后，提供高质量的预测

### 学生模型的训练

- 学生模型是一个较小的网络，其复杂度和参数量远低于教师模型
- 通过模仿教师模型的预测，学生模型逐渐学会在相同任务上的推理能力

### 知识蒸馏的实现

- 教师模型通过训练数据生成预测，并将这些预测传递给学生模型
- 学生模型不仅学习数据的真实标签，还可以通过模仿教师模型的预测结果，捕捉额外的知识

## DeepSeek-R1 如何通过知识蒸馏把推理能力迁移到 Qwen

### 核心原理

#### 模板：结构化的输出格式

**定义：模板是预先设计的文本格式，用于规范模型的输出**

- <think>: 标记推理过程的开始
- </think>: 标记推理过程的结束
- <answer>: 标记最终答案的开始
- </answer>: 标记最终答案的结束

**作用：**

- 清晰性：像填空题的 提示词 一样，告诉模型思考过程写在这里，答案写在那里
- 一致性：确保所有输出遵循相同结构，便于后续处理和分析
- 可读性：人类可以轻松区分推理过程和答案，提升用户体验

#### 推理轨迹：模型解题的 "思考链"

**定义：模型在解决问题时生成的详细步骤也即解决问题时的思考过程，如下**

```
<think>
  1. 问题分析：方程的结构是否可以因式分解？
  2. 尝试分解：x²-5x+6 = (x-2)(x-3)
  3. 验证解：x=2和x=3代入原方程成立。
</think>
<answer>
  解为x=2或x=3
</answer>
```

**作用：展示模型的逻辑链，使答案生成过程透明化**

#### 拒绝采样：从试错中筛选优质数据

**定义：生成多个候选答案，通过规则筛选保留高质量样本**

**过程：**

- 生成：模型对同一问题输出多个推理轨迹
- 过滤：通过自动化规则（如答案正确性检查）或人工审核，剔除错误和低质量样本
- 保留：仅将优质样本加入训练集

### 蒸馏数据的生成：如何准备 教学材料

`
知识蒸馏的第一步是生成高质量的教学数据，供小模型学习
`

#### 数据来源

- 推理原理（80%）：由 DeepSeek-R1 生成，覆盖数学、编程、逻辑推理等任务
- 通用数据（20%）：来自 DeepSeek-V3 的通用任务数据（如写作、问答），确保小模型的多任务能力

#### 数据生成流程

- 模板引导生成：要求 DeepSeek-R1 按照 <think> 和 <answer> 模板输出推理轨迹
- 拒绝采样筛选
  - 规则过滤：自动检查答案正确性（如数学答案是否符合公式）
  - 可读性检查：剔除语言混合（中英文混杂）或冗长段落
- 数据整合：最终形成 80万条高质量样本，其中推理数据约 60 万条，通用数据约 20 万条

### 蒸馏过程：如何让小模型 学以致用

#### 教师和学生角色

- 教师模型：DeepSeek-R1（复杂的大模型，擅长推理）
- 学生推理：Qwen 模型（如： Qwen-7B，参数较小，需学习推理能力）

#### 训练步骤

- 数据输入：将 80 万样本中的问题部分输入 QWen 模型，需求其按模型生成完整的推理轨迹（思考过程 + 答案）
- 损失计算：对比学生模型生成的完整输出与教师模型（样本）的推理轨迹，通过监督微调（SFT） 对齐文本序列
- 参数更新：通过反向传播优化 Qwen 的模型参数，使其逼近教师模型的输出
- 迭代训练：重复多轮训练，确保知识充分迁移

### 实例演示：从方程求解看蒸馏结果

#### 任务示例

- 输入：解方程 (x²-5x+6=0)
- 教师模型的标准输出：

```
<think>
  1. 观察方程结构：二次项系数为1，常数项为6。
  2. 寻找两个数a和b，使得a+b=5且ab=6。
  3. 得出a=2，b=3，因此方程可分解为(x-2)(x-3)=0。
  4. 解得x=2或x=3。
</think>
<answer>
  x=2 或 x=3
</answer>
```

#### 蒸馏前后的对比

**蒸馏前 QWen-7B 的输出**

```
<answer>
  答案是2和3
</answer>
```

- 问题: 缺乏推理过程，答案正确但不可解释


**蒸馏后 Qwen-7B 输出**

```
<think>
  1. 尝试因式分解：x²-5x+6=(x-2)(x-3)。
  2. 验证解：x=2和x=3满足原方程。
</think>
<answer>
  x=2 或 x=3
</answer>
```

- 改进：生成结构化推理过程，答案与教师模型一致





**Reference**

- [DeepSeek-R1如何通过知识蒸馏把推理能力迁移到千问Qwen](https://mp.weixin.qq.com/s/0MbRVsYxiZfY6b_P20bjNA)




